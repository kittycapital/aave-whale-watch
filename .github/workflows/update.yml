name: ðŸ‹ Update Aave Data

on:
  # 4ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€: 0, 4, 8, 12, 16, 20ì‹œ)
  schedule:
    - cron: '0 */4 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
  
  # Push ì‹œì—ë„ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  push:
    branches:
      - main
    paths:
      - 'scripts/**'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“Š Fetch Aave Data
        run: |
          cd scripts
          python fetch_data.py
        env:
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
          PYTHONUNBUFFERED: '1'
      
      - name: ðŸ“ Check for changes
        id: git-check
        run: |
          git diff --exit-code data/ || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: ðŸš€ Commit and Push
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add timestamp to commit message
          TIMESTAMP=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
          
          git add data/
          git commit -m "ðŸ‹ ë°ì´í„° ì—…ë°ì´íŠ¸: ${TIMESTAMP}"
          git push
      
      - name: âœ… Summary
        run: |
          echo "## ðŸ‹ Aave Whale Watch Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì—…ë°ì´íŠ¸ ì‹œê°„:** $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f data/ethereum.json ]; then
            ETH_COUNT=$(cat data/ethereum.json | python -c "import sys, json; print(len(json.load(sys.stdin).get('positions', [])))")
            echo "- **Ethereum:** ${ETH_COUNT} positions" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/arbitrum.json ]; then
            ARB_COUNT=$(cat data/arbitrum.json | python -c "import sys, json; print(len(json.load(sys.stdin).get('positions', [])))")
            echo "- **Arbitrum:** ${ARB_COUNT} positions" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/polygon.json ]; then
            POLY_COUNT=$(cat data/polygon.json | python -c "import sys, json; print(len(json.load(sys.stdin).get('positions', [])))")
            echo "- **Polygon:** ${POLY_COUNT} positions" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/base.json ]; then
            BASE_COUNT=$(cat data/base.json | python -c "import sys, json; print(len(json.load(sys.stdin).get('positions', [])))")
            echo "- **Base:** ${BASE_COUNT} positions" >> $GITHUB_STEP_SUMMARY
          fi
